{% extends 'app_transportador/base_transportador.html' %}
{% load static %}

{% block content %}

<style>
  /* Estilos para a tabela de pedidos */
  #tabela-pedidos-container .table {
    background-color: #ffffff; /* Fundo branco */
    color: #212529; /* Texto escuro */
  }
  
  #tabela-pedidos-container .table th {
    background-color: #f8f9fa; /* Cor de fundo do cabeçalho */
    color: #495057;
  }
  
  #tabela-pedidos-container .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.02); /* Listras suaves */
  }
  
  #tabela-pedidos-container .table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05); /* Efeito hover */
  }
  
  /* Melhoria para os badges de status */
  .badge.bg-info { background-color: #0dcaf0!important; }
  .badge.bg-danger { background-color: #dc3545!important; }
  .badge.bg-warning { color: #000; background-color: #ffc107!important; }
  .badge.bg-success { background-color: #198754!important; }

  /* Estilos gerais */
  .card {
    transition: transform 0.2s;
  }
  .card:hover {
    transform: translateY(-5px);
  }
  .spin {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    100% { transform: rotate(360deg); }
  }
  
  /* Notificação de novo pedido */
  .toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1100;
  }
</style>

<main class="col-md-12 ms-sm-auto col-lg-12">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 text-warning mt-3 d-flex align-items-center">
      <span data-feather="truck" class="me-2"></span>
      PAINEL DO TRANSPORTADOR
    </h1>
  </div>

  <div class="container">
    <div class="card bg-dark text-white">
      <div class="card-body d-flex justify-content-between align-items-center">
          <h3 class="card-title">
              <span data-feather="credit-card" class="me-2"></span>
              Controle de Pedidos
          </h3>
      </div>
  </div>
    <div class="row g-4 mt-2">
      <!-- Card Novos -->
      <div class="col-md-3">
        <a href="{% url 'transportador:tabela_pedidos_filtrado' %}?status=NOVO" class="text-decoration-none">
          <div class="card border-info shadow-sm h-100 hover-scale">
            <div class="card-body text-center">
              <h5 class="card-title text-info">NOVOS</h5>
              <p class="card-value display-6 text-info" id="novos">0</p>
            </div>
          </div>
        </a>
      </div>
      
      <!-- Card Pendentes -->
      <div class="col-md-3">
        <a href="{% url 'transportador:tabela_pedidos_filtrado' %}?status=PENDENTE" class="text-decoration-none">
          <div class="card border-danger shadow-sm h-100 hover-scale">
            <div class="card-body text-center">
              <h5 class="card-title text-danger">PENDENTES</h5>
              <p class="card-value display-6 text-danger" id="pendentes">0</p>
            </div>
          </div>
        </a>
      </div>
      
      <!-- Card Atendidos -->
      <div class="col-md-3">
        <a href="{% url 'transportador:tabela_pedidos_filtrado' %}?status=ATENDIDO" class="text-decoration-none">
          <div class="card border-warning shadow-sm h-100 hover-scale">
            <div class="card-body text-center">
              <h5 class="card-title text-warning">ATENDIDOS</h5>
              <p class="card-value display-6 text-warning" id="atendidos">0</p>
            </div>
          </div>
        </a>
      </div>
      
      <!-- Card Finalizados -->
      <div class="col-md-3">
        <a href="{% url 'transportador:tabela_pedidos_filtrado' %}?status=FINALIZADO" class="text-decoration-none">
          <div class="card border-success shadow-sm h-100 hover-scale">
            <div class="card-body text-center">
              <h5 class="card-title text-success">FINALIZADOS</h5>
              <p class="card-value display-6 text-success" id="finalizados">0</p>
            </div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Tabela de pedidos -->
  <div id="tabela-pedidos-container" class="mt-4">
    {% include 'app_transportador/tabela_pedidos.html' %}
  </div>
</main>


<!-- Ícones Feather -->
<script src="https://unpkg.com/feather-icons"></script>
<script>
  // ==============================
  // VARIÁVEIS GLOBAIS
  // ==============================
  let contagemAnterior = null; // começa como null para não disparar som na primeira carga
  let intervaloAtualizacao;
  const audio = new Audio("{% static 'audio/bip.mp3' %}");
  audio.preload = "auto"; // garante pré-carregamento do áudio

  // ==============================
  // FUNÇÕES DE ATUALIZAÇÃO
  // ==============================

  // Atualiza cards e badges
  function atualizarDashboard(dados) {
    document.getElementById("novos").textContent = dados.novos;
    document.getElementById("pendentes").textContent = dados.pendentes;
    document.getElementById("atendidos").textContent = dados.atendidos;
    document.getElementById("finalizados").textContent = dados.finalizados;

    const badges = {
      "badge-novos-count": dados.novos,
      "badge-pendentes-count": dados.pendentes,
      "badge-atendidos-count": dados.atendidos,
      "badge-finalizados-count": dados.finalizados,
    };

    for (const [id, valor] of Object.entries(badges)) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = valor;
        el.style.display = valor > 0 ? "inline-flex" : "none";
      }
    }
  }

  // Atualiza tabela de pedidos (HTML vindo da view)
  async function atualizarTabelaPedidos() {
    try {
      const response = await fetch("{% url 'transportador:tabela_pedidos' %}");

      if (response.status === 401) {
        window.location.href = "{% url 'transportador:login_transportador' %}";
        return;
      }
      if (!response.ok) throw new Error("Erro ao carregar tabela");

      const html = await response.text();
      document.getElementById("tabela-pedidos-container").innerHTML = html;
      feather.replace();
    } catch (error) {
      console.error("Erro ao atualizar tabela:", error);
      document.getElementById("tabela-pedidos-container").innerHTML = `
        <div class="alert alert-danger">
          Erro ao carregar pedidos. Tente novamente.
        </div>
      `;
    }
  }

  // Atualiza dados gerais e dispara notificações/som
  async function atualizarDadosCompletos() {
    try {
      const response = await fetch("{% url 'transportador:dados_pedidos' %}");

      if (response.status === 401) {
        window.location.href = "{% url 'transportador:login_transportador' %}";
        return;
      }
      if (!response.ok) throw new Error("Erro ao carregar dados");

      const dados = await response.json();
      console.log(dados.novos)
      console.log(contagemAnterior)
      // Detecta aumento de pedidos novos
    if (contagemAnterior !== null && dados.novos > contagemAnterior) {
      const novosPedidos = dados.novos - contagemAnterior;
      mostrarNotificacao(novosPedidos);

        audio.currentTime = 0; // reinicia áudio sempre
        audio.play().catch(err =>
          console.warn("Erro ao reproduzir áudio:", err)
        );
      }
      contagemAnterior = dados.novos;

      // Atualiza interface
      atualizarDashboard(dados);
      await atualizarTabelaPedidos();

    } catch (error) {
      console.error("Erro na atualização:", error);
    }
  }

  // ==============================
  // NOTIFICAÇÕES
  // ==============================
  function mostrarNotificacao(quantidade) {
    const notification = document.createElement("div");
    notification.className = "toast-notification";
    notification.innerHTML = `
      <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-primary text-white">
          <strong class="me-auto">Novo(s) Pedido(s)</strong>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
            aria-label="Close" onclick="this.closest('.toast-notification').remove()"></button>
        </div>
        <div class="toast-body">
          Você tem ${quantidade} novo(s) pedido(s)!
        </div>
      </div>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
  }

  // ==============================
  // INTERAÇÕES
  // ==============================
  function atualizarDadosManual(event) {
    const btn = event.currentTarget;
    const originalHtml = btn.innerHTML;

    btn.innerHTML =
      '<span data-feather="refresh-cw" class="spin"></span> Atualizando...';
    feather.replace();

    atualizarDadosCompletos().finally(() => {
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        feather.replace();
      }, 1000);
    });
  }

  // ==============================
  // INICIALIZAÇÃO
  // ==============================
  document.addEventListener("DOMContentLoaded", () => {
    feather.replace();

    // Primeira atualização
    atualizarDadosCompletos();

    // Atualização periódica (10s)
    intervaloAtualizacao = setInterval(atualizarDadosCompletos, 10000);
  });

  // Pausa/retoma quando aba perde foco
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      clearInterval(intervaloAtualizacao);
    } else {
      atualizarDadosCompletos();
      intervaloAtualizacao = setInterval(atualizarDadosCompletos, 10000);
    }
  });
</script>


{% endblock %}